<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restoran Görü Sistemi</title>
    <style>
        :root {
            --dark-panel: #2c3e50; --medium-panel: #34495e; --light-text: #ecf0f1;
            --accent-blue: #3498db; --success-green: #2ecc71; --warning-orange: #e67e22;
            --info-blue: #3498db;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f0f2f5; }
        .container { display: flex; width: 100%; height: 100%; }
        .video-container { flex-grow: 1; display: flex; flex-direction: column; background-color: black; padding: 20px; box-sizing: border-box; }
        .video-container h1 { color: var(--light-text); text-align: center; margin: 0 0 20px 0; }
        #video-wrapper { flex-grow: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #video_feed { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; }
        .panel-container { flex-basis: 380px; flex-shrink: 0; padding: 20px; background-color: var(--dark-panel); color: var(--light-text); display: flex; flex-direction: column; }
        .panel-container h2 { text-align: center; border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 0; }
        
        #status-panel {
            padding: 15px; margin-bottom: 20px; border-radius: 6px; font-size: 1.2em;
            font-weight: bold; text-align: center; transition: all 0.4s ease;
        }
        #status-panel.waiting { background-color: var(--warning-orange); color: white; }
        #status-panel.ready { background-color: var(--info-blue); color: white; }
        #status-panel.new-order { background-color: var(--success-green); color: white; }

        #order-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        #order-list li { background-color: var(--medium-panel); margin: 0 0 10px 0; padding: 12px 15px; border-radius: 5px; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        .item-name { font-weight: bold; } .item-details { color: #bdc3c7; }
        .total-bill { font-size: 2em; font-weight: bold; text-align: right; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--medium-panel); color: var(--success-green); }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sipariş Paneli -->
        <div class="panel-container">
            <h2>Sipariş Paneli</h2>
            <div id="status-panel" class="waiting">Yükleniyor...</div>
            <ul id="order-list"></ul>
            <div class="total-bill">TOPLAM: <span id="total-bill-amount">0.00</span> TL</div>
        </div>
        <!-- Video Alanı -->
        <div class="video-container">
            <h1>Canlı Masa Analizi</h1>
            <div id="video-wrapper">
                 <img id="video_feed" src="{{ url_for('video_feed') }}" alt="Video Akışı">
            </div>
        </div>
    </div>

    <script>
        async function updateData() {
            try {
                const response = await fetch('/get_data');
                const data = await response.json();

                // 1. Durum Panelini Güncelle
                const statusPanel = document.getElementById('status-panel');
                const statusMessage = data.status_message;
                statusPanel.textContent = statusMessage;
                
                if (statusMessage.includes("BEKLENİYOR")) {
                    statusPanel.className = 'waiting';
                } else if (statusMessage.includes("YENİ SİPARİŞ")) {
                    statusPanel.className = 'new-order';
                } else {
                    statusPanel.className = 'ready';
                }
                
                // 2. Sipariş Listesini Güncelle
                const orderList = document.getElementById('order-list');
                orderList.innerHTML = ''; // Listeyi temizleyip yeniden çizmek en basit ve hatasız yöntemdir.
                
                for (const item in data.order_summary) {
                    const { count, price } = data.order_summary[item];
                    const single_price = price / count;
                    const itemNameFormatted = item.replace(/_/g, ' ').toUpperCase();
                    
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span class="item-name">${itemNameFormatted}</span>
                        <span class="item-details">${count} adet x ${single_price.toFixed(2)} TL</span>
                    `;
                    orderList.appendChild(listItem);
                }

                // 3. Toplam Tutarı Güncelle
                document.getElementById('total-bill-amount').textContent = data.total_bill.toFixed(2);

            } catch (error) {
                console.error('Veri güncellenirken hata oluştu:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setInterval(updateData, 1000); // Saniyede bir güncelle
        });
    </script>
</body>
</html>